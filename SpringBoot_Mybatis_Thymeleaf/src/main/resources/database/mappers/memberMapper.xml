<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
  <mapper namespace="com.ee.y1.member.MemberMapper">
  
  	<!-- Login  -->
	<select id="memberLogin" parameterType="MemberVO" resultMap="getLoginResult">
		SELECT M.*, R.* 
		FROM member M LEFT JOIN member_role MR
		ON M.username = MR.username
		inner JOIN role R
		ON MR.id = R.id
		WHERE M.username=#{username}
		
	</select>
	
	<resultMap type="MemberVO" id="getLoginResult">
		<id column="username" property="username"/>
		<result column="password" property="password"/>
		<result column="name" property="name"/>
		<result column="email" property="email"/>
		<result column="phone" property="phone"/>
		<result column="enabled" property="enabled"/>
		<collection property="roles" javaType="java.util.List" ofType="RoleVO">
			<id column="id" property="id"/>
			<result column="roleName" property="roleName"/>
		</collection>
		
	</resultMap>

	
	<!-- member Join -->
	<insert id="setMemberJoin" parameterType="MemberVO">
		<!-- ignore안쓰면 중복실행되서 오류남 / 참고 : https://til.songyunseop.com/mysql/some_case_insert_with_duplicated_key.html -->
		insert IGNORE into member(username, password, name, phone, email, enabled) 
		values(#{username}, #{password}, #{name}, #{phone}, #{email}, #{enabled})	
	</insert>
	
	
	<insert id="setMemberRole" parameterType="java.util.Map">
		insert into member_role (username, id)
		values(#{username}, (select id from role where roleName=#{roleName}))
	</insert>
	
	
	<!-- file upload -->		<!-- autoIncrements -->
	<insert id = "setFileInsert" useGeneratedKeys="true" parameterType="MemberFileVO">
		insert into memberfiles(username, fileName, oriName) 
		values(#{username}, #{fileName}, #{oriName})
	</insert>
	
	<!-- getUsername -->
	<select id="getUsername" parameterType="MemberVO" resultType="MemberVO">
			select * from member where username=#{username}
	</select>
	
  
  
  </mapper>